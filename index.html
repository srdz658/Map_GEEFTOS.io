<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte de mes amis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #top-bar {
      padding: 8px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    #top-bar form {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    #top-bar input, #top-bar label {
      font-size: 14px;
    }
    #top-bar input[type="text"] {
      padding: 4px 6px;
    }
    #map {
      width: 100%;
      height: calc(100% - 56px);
    }
    #status {
      font-size: 13px;
    }
    #welcome-message {
  position: relative;
  padding: 12px 16px;
  background: #fafafa;
  border-bottom: 1px solid #ddd;
  font-size: 15px;
  line-height: 1.4;
  text-align: center;
  color: #444;
}

#welcome-close {
  position: absolute;
  top: 6px;
  right: 10px;
  font-size: 18px;
  cursor: pointer;
  color: #888;
  transition: 0.2s;
}

#welcome-close:hover {
  color: #333;
}

#welcome-text {
  max-width: 800px;
  margin: 0 auto;
}

  </style>
</head>
<body>
<div id="welcome-message">
  <div id="welcome-close">×</div>
  <div id="welcome-text">
    Coucou les geeftoooos !<br>
    Voici un petit site pour montrer où vous êtes, ce que vous faites, si vous bougez ou pas, 
    et si vous avez un lit dispo pour les copains qui passent. Comme ça, 
    les gens en VDI sauront où loger, se poser, et squatter <3.<br><br>
    Je vous aime fort !<br>
    — Stanislas (VDI professionnel depuis 25 ans)

    PS: si vous voulez d'autres fonctionnalités hésitez pas mdrr, j'ai du temps à tuer. 
  </div>
</div>
<div id="top-bar">
  <form id="add-friend-form">
    <input type="text" id="name" placeholder="Ton prénom" required />
    <input type="text" id="address" placeholder="Ta ville (pas l’adresse exacte)" required />
    <input type="text" id="comment" placeholder="Salut, je suis ici !" />
    <label>
      <input type="checkbox" id="status-sdf" />
      VDI
    </label>
    <button type="submit">Me placer / mettre à jour</button>
    <span id="status"></span>
  </form>
</div>

<div id="map"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.getElementById("welcome-close");
    const msg = document.getElementById("welcome-message");

    closeBtn.addEventListener("click", () => {
      msg.style.display = "none";
    });
  });
</script>
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwWTaw77mT9sts_MdpAunct1kmCtJD7ujaWFzDWD0Q4D9XmOzFbttRsZpO2nwcaEoMI/exec";

  console.log("API_URL =", API_URL);

  const map = L.map('map').setView([46.5, 2.5], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const statusSpan = document.getElementById('status');
  const form = document.getElementById('add-friend-form');
  const commentInput = document.getElementById('comment');
  const statusCheckbox = document.getElementById('status-sdf');

  // pour supprimer l'ancien marker quand on met à jour
  const markersByName = {};

  function showStatus(message) {
    console.log("STATUS:", message);
    statusSpan.textContent = message;
  }

  function addOrReplaceMarker(friend) {
    const name = friend.name;
    const lat = parseFloat(friend.lat);
    const lng = parseFloat(friend.lng);
    const comment = friend.comment && friend.comment.trim() !== "" ? friend.comment : "Salut, je suis ici !";
    const status = friend.status === "VDI" ? " (VDI)" : "";

    // supprimer ancien marker si existe
    if (markersByName[name]) {
      map.removeLayer(markersByName[name]);
    }

    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(
      `<strong>${name}${status}</strong><br>${friend.address}<br><em>${comment}</em>`
    );

    markersByName[name] = marker;
    return marker;
  }

  // Charger les amis au chargement
  async function loadFriends() {
    try {
      showStatus('Chargement des amis...');
      console.log("GET", API_URL);
      const response = await fetch(API_URL);
      console.log("GET response status:", response.status);
      const data = await response.json();
      console.log("GET data:", data);

      if (!Array.isArray(data) || data.length === 0) {
        showStatus('Aucun ami enregistré pour l’instant.');
        return;
      }

      const bounds = [];
      data.forEach(friend => {
        addOrReplaceMarker(friend);
        bounds.push([parseFloat(friend.lat), parseFloat(friend.lng)]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }

      showStatus(`Amis chargés: ${data.length}`);
    } catch (err) {
      console.error('Erreur loadFriends', err);
      showStatus('Erreur en chargeant les données.');
    }
  }

  // Géocodage via Nominatim
  async function geocode(address) {
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q='
      + encodeURIComponent(address);

    console.log("Geocode URL:", url);

    const response = await fetch(url, {
      headers: {
        'Accept': 'application/json'
      }
    });

    console.log("Geocode status:", response.status);

    if (!response.ok) {
      throw new Error('Erreur réseau géocodage');
    }

    const data = await response.json();
    console.log("Geocode data:", data);

    if (!Array.isArray(data) || data.length === 0) {
      throw new Error('Adresse introuvable');
    }

    const result = data[0];
    return {
      lat: parseFloat(result.lat),
      lng: parseFloat(result.lon)
    };
  }

  // Sauvegarde (Content-Type "simple" pour éviter le préflight CORS)
  async function saveFriend(friend) {
    console.log("POST", API_URL, "body:", friend);
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8'
      },
      body: JSON.stringify(friend)
    });

    console.log("POST response status:", response.status);

    const data = await response.json();
    console.log("POST response data:", data);

    if (data.status !== 'ok') {
      throw new Error('Erreur côté API');
    }
    return data;
  }

  // Gestion du formulaire
  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const name = document.getElementById('name').value.trim();
    const address = document.getElementById('address').value.trim();
    let comment = commentInput.value.trim();
    if (!comment) {
      comment = "Salut, je suis ici !";
    }
    const statusValue = statusCheckbox.checked ? "VDI" : "";

    if (!name || !address) {
      showStatus('Remplis nom et adresse.');
      return;
    }

    // Étape 1 : géocodage
    let coords;
    showStatus('Recherche de ta position...');
    try {
      coords = await geocode(address);
    } catch (err) {
      console.error('Erreur geocode', err);
      showStatus("Adresse introuvable. Essaie juste ta ville (ex: Lyon).");
      return;
    }

    const friend = {
      name: name,
      address: address,
      lat: coords.lat,
      lng: coords.lng,
      comment: comment,
      status: statusValue
    };

    // Étape 2 : sauvegarde
    showStatus('Sauvegarde sur le serveur...');
    let result;
    try {
      result = await saveFriend(friend);
    } catch (err) {
      console.error('Erreur API', err);
      showStatus("Erreur côté serveur (API).");
      return;
    }

    addOrReplaceMarker(friend);
    map.setView([coords.lat, coords.lng], 10);

    if (result.updated) {
      showStatus('Position mise à jour.');
    } else {
      showStatus('Position ajoutée.');
    }

    form.reset();
    // pas de valeur par défaut, juste le placeholder gris
  });

  // Démarrage
  loadFriends();
</script>
</body>
</html>
